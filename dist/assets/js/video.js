const video=document.querySelector("video"),canvas=document.querySelector("canvas"),customCanvas=document.getElementById("customCanvas");let ctx,data,width=150,height=150;const setDimensions=(e,t)=>{customCanvas.style.width=e,customCanvas.style.height=t};let delay=60,hasStarted=!1,isProcessing=!1,isColor=!1,canColorize=!1,interval;const handleWindowResize=()=>{var e=document.body.clientWidth+96;canColorize=e<768?(75<width&&isProcessing&&startStreaming(),width=75,!(height=75)):(width<150&&isProcessing&&startStreaming(),width=150,height=150,!0),setDimensions(width+.1+"ch",height+.1+"ch")},startStreaming=(handleWindowResize(),window.onresize=handleWindowResize,()=>{navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{min:150,ideal:1280,max:1920},height:{min:150,ideal:720,max:1080}}}).then(e=>{video.srcObject=e,ctx=canvas.getContext("2d"),startProcessing(),isProcessing=!0,hasStarted=!0}).catch(e=>console.error(e))}),startProcessing=()=>{clearInterval(interval),interval=setInterval(processFrame,delay)},stopProcessing=()=>{clearInterval(interval),isProcessing=!1},processFrame=()=>{0<video.videoWidth&&(ctx.drawImage(video,0,0,width,height),transformFrame(ctx.getImageData(0,0,width,height).data),setDimensions(width+.1+"ch","auto"))},hiddenInput=document.getElementById("hidden-input"),copyFrame=()=>{hasStarted?(hiddenInput.innerHTML=customCanvas.innerHTML.replace(/\&nbsp;/gi," ").replace(/<i class=\"c[0-9]*\">/gi,"").replace(/<\/i>/gi,"").replace(/<br\s*[\/]?>/gi,"\r\n"),hiddenInput.select(),hiddenInput.setSelectionRange(0,999999999999),navigator.clipboard.writeText(hiddenInput.value)):console.error("Cannot copy frame if not processing first.")},hiddenDownload=document.getElementById("hidden-download"),downloadFrame=()=>{hasStarted?domtoimage.toPng(customCanvas).then(function(e){hiddenDownload.download=`ascii-stream-frame-${Date.now()}.png`,hiddenDownload.href=e,hiddenDownload.click()}).catch(function(e){console.error("Error downloading frame",e)}):console.error("Cannot download frame if not processing first.")};let thresholdFactor=.35,__baseAlpha="Ñ@#W$9876543210?!abc;:+=-,._ ";const alphaColorMap={"Ñ":"c1","@":"c2","#":"c3",W:"c4",$:"c5",9:"c6",8:"c7",7:"c8",6:"c9",5:"c10",4:"c12",3:"c13",2:"c14",1:"c15",0:"c16","?":"c17","!":"c18",a:"c19",b:"c20",c:"c21",";":"c22",":":"c23","+":"c24","=":"c25","-":"c26",",":"c27",".":"c28",_:"c29"," ":"c30","":"c30"};let __alpha,alpha,alphaLen;const factorLabel=document.getElementById("factor-label"),changeFactor=e=>{thresholdFactor=e/100,__alpha=__baseAlpha;for(let e=0;e<Math.floor(__baseAlpha.length*thresholdFactor);e++)__alpha+=" ";alpha=__alpha.split().reverse().join(),alphaLen=alpha.length,factorLabel.innerHTML=Math.round(100*thresholdFactor)/100},fpsLabel=(changeFactor(50),document.getElementById("fps-label")),changeFps=e=>{delay=1e3/e,fpsLabel.innerHTML=e,startProcessing()},toggleColorize=(changeFps(16),()=>{canColorize&&(isColor=!isColor,setDimensions(isColor?"unset":width+.1+"ch",isColor?"unset":height+.1+"ch"))});let targetChar,result,item,value,char;const getChar=e=>(targetChar=alpha.charAt(Math.floor(e*alphaLen)),isColor?" "===targetChar?"&nbsp;":'<i class="'+alphaColorMap[targetChar]+'">'+targetChar+"</i>":" "===targetChar?"&nbsp;":targetChar),getPixelValue=(e,t,a)=>Math.max(e,t,a)/255,transformFrame=a=>{result="";for(let t=0;t<height;t++){for(let e=width-1;0<=e;e--)item=t*height+e,value=getPixelValue(a[4*item],a[4*item+1],a[4*item+2]),char=getChar(value),result+=char;result+="<br/>"}customCanvas.innerHTML=result};